#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

GROONGA_VERSION=2.0.9
GROONGA_DATABASE_PATH=groonga/database

echo "-----> Installing groonga $VERSION"

cd $1

curl http://cloud.github.com/downloads/groonga/heroku-buildpack-groonga/groonga-$GROONGA_VERSION.tgz -s -O
mkdir -p vendor/groonga
tar -C vendor/groonga -xf groonga-$GROONGA_VERSION.tgz
rm groonga-$GROONGA_VERSION.tgz

export PATH=$PATH:$1/vendor/groonga/bin
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$1/vendor/groonga/lib

echo "-----> Modifying groonga-httpd.conf"
sed --in-place -e "s|# groonga_database /path/to/groonga/db;|groonga_database /app/$GROONGA_DATABASE_PATH;|" $1/vendor/groonga/etc/groonga/httpd/groonga-httpd.conf

echo "-----> Creating groonga database"
groonga -n $GROONGA_DATABASE_PATH

echo "-----> Loading data"
find groonga -name "*.grn" | sort | xargs -t -I % -n 1 -P 1 groonga --file % $GROONGA_DATABASE_PATH
