#!/usr/bin/env ruby
# bin/compile <build-dir> <cache-dir>

require "rbconfig"
require "fileutils"

include FileUtils

build_dir, cache_dir, env_dir, = ARGV

version = "4.0.1"
database_path = "groonga/database"

def sh(*command_line)
  puts(command_line.join(" "))
  system(*command_line) or exit(false)
end

def ruby(*command_line)
  command_line.unshift(RbConfig.ruby)
  sh(*command_line)
end

Dir.chdir(build_dir) do
  puts("-----> Installing Groonga #{version}")

  base_url = "https://github.com/groonga/groonga/releases/download/v#{version}"
  base_name = "heroku-groonga-#{version}.tar.xz"
  sh("curl",
     "--silent",
     "--remote-name",
     "--location",
     "#{base_url}/#{base_name}")
  sh("tar", "xf", base_name)
  rm(base_name)

  groonga_dir = "vendor/groonga"
  rm(Dir.glob("#{groonga_dir}/lib/**/*.a"))
  rm_r("#{groonga_dir}/share/groonga/examples")
  rm_r("#{groonga_dir}/share/groonga/images")

  puts("-----> Creating Groonga database")
  ENV["PATH"] = [
    "#{build_dir}/#{groonga_dir}/bin",
    ENV["PATH"],
  ].join(File::PATH_SEPARATOR)
  ENV["LD_LIBRARY_PATH"] = [
    "#{build_dir}/#{groonga_dir}/lib",
    ENV["LD_LIBRARY_PATH"],
  ].join(File::PATH_SEPARATOR)
  sh("groonga", "-n", database_path, "quit")

  puts("-----> Loading data")
  Dir.glob("groonga/*.grn").sort.each do |grn|
    sh("groonga", "--file", grn, database_path)
    rm(grn)
  end
end
