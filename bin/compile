#!/usr/bin/env ruby
# bin/compile <build-dir> <cache-dir>

require "fileutils"

build_dir, cache_dir, env_dir, = ARGV

version = "4.0.1"
database_path = "groonga/database"

Dir.chdir(build_dir) do
  puts("-----> Installing Groonga #{version}")

  base_name = "heroku-groonga-#{version}.tar.xz"
  system("curl",
         "--silent",
         "--remote-name",
         "http://groonga-builder.herokuapp.com/#{base_name}")
  system("tar", "xf", base_name)
  FileUtils.rm(base_name)

  puts("-----> Creating groonga database")
  ENV["PATH"] = [
    "#{build_dir}/vendor/groonga/bin",
    ENV["PATH"],
  ].join(File::PATH_SEPARATOR)
  ENV["LD_LIBRARY_PATH"] = [
    "#{build_dir}/vendor/groonga/lib",
    ENV["LD_LIBRARY_PATH"],
  ].join(File::PATH_SEPARATOR)
  system("groonga", "-n", database_path, "quit")

  puts("-----> Loading data")
  Dir.glob("groonga/*.grn").sort.each do |grn|
    system("groonga", "--file", grn, database_path)
  end
end
